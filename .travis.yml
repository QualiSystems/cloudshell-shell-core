language: python
python: 3.7
jobs:
  include:
    - if: branch = master
      python: 2.7
      env: TOXENV=py27-master
      after_success: codecov
    - if: branch = master
      env: TOXENV=py37-master
      after_success: codecov
    - if: branch != master
      python: 2.7
      env: TOXENV=py27-dev
      after_success: codecov
    - if: branch != master
      env: TOXENV=py37-dev
      after_success: codecov
    - env: TOXENV=build
    - env: TOXENV=pre-commit
    - stage: Deploy to Test PyPI release
      env: TOXENV=build
      before_script: sed -i -E "s/^([0-9]+\.[0-9]+\.[0-9]+)$/\1.$TRAVIS_BUILD_NUMBER/" version.txt
      deploy:
        distributions: skip
        skip_cleanup: true
        provider: pypi
        server: https://test.pypi.org/legacy/
        user: "__token__"
        password:
          secure: "N6xvWe7XsQ/gq6xjPvgj90T41DbY9778U3TebAMk9jfBUQbSRqivmnWR+vT/ScxnLOZXCw5tNOBZKh2yiF9YlNfob31MWYS2IEmTwLXl20G04XWll1UQafRy0EnhIYQe496a+dsqRrEHJfS7NmAnVPo/wYNWe/rf+Fc+sNnLFWtPv7Ekv/UI2l32XuUXa0iCH4Ies/d579a2HcVgXD35PGb47tWMvkT8Pz4s4Qg1iyWAW+bUJkDEay1matJNB8Zz0bv9BwhBMJD3RY9ScFFLw75QMAhaEaC+rCs7ivMXsf4kl5jkbuTW9qTZj4Sx7KqMniTMdj0YmPaGq/s/l+glWfL8UhoQ0o3WBcjSjgYOMAh6563ZCpb3wXYQzc40P25A+Y9I7qb/YJ3S3oD5etU/hovgym0X6PTr0tjpfG+Ldg7KXq/SvW1nf7qtqhS/LRWWBi1EZDRrtDCQ5ii53Qpw/hyhcUyRFbwvWWd/NDUwTOgblkqu0zPslYdlDPOu/exLLScANIcaVk0vynUfFSpGhCFiETimD8bZ1fd0iEATedxj1wmEdbpQMJiyQZYpcRUQuritIH72anhhl/agOmCyc9qaUwuxS57fDJaclesAwWFjBmRx5OA/UrxhfhFgvipnXvvWoNap9R9VzhQvg4SMl3d0Ox5XSURHXkYjvRJSrHM="
        on:
          branch: dev
    - stage: Deploy to PyPI release
      env: TOXENV=build
      deploy:
        distributions: skip
        skip_cleanup: true
        provider: pypi
        user: "__token__"
        password:
          secure: "sU1SowRS6KhOGcBzjQgolEAeZobB77R51igUIz78VviWAlQJ1QQdFA8EU31u5Tc6rsyBm3cHDL4t12eC+pj7GshJLbjoIbUaCCWSkKvMRq6LmqZoxQPrF6N9y6WYf4ELSsKu62H6Lcwu69Tgx5iEA6+x8/C3Z/gB9a2H39H3Ycdjtiw4cGv16a8u2iFQml78RfUJuWh33JOVNuM9HmtedzpEvd5oYE4SX571baJPg/rzewgcIt7gI9hEoANkm9rNf9TcrNjfCUfjMGkM6tWvZ/okgWHWVlBX0bkQShcaoXdvV8yT9tR382aAl6LS18POS+vqY4Jj22VoOqk1DANhITRf+WQRohSthZ4muWLu5AD6QI92Lfq4VPp8ljzneqU03cBUGtdLf+xLWDKyePD+M5sdA+xY97cdbrEMV8KowbhcBPTB5ds4SyKFWkDKVMuLkujI6unW2VA+P8/85VUrV8OVj8RGeVsg9wA5ip9aIZRAdrslyq3FAjN7v3aPerusS993rsD95UIceWGiaj+ZZm8lEjc3C+jJTYbaZ4arUegOTn3WqOLCSAY/C3/zOLMO7phqq+hPu2yi8S5OfhFxW3WDO/36GxCJKoydCxtXtYmP52RXmGClAQm44NEY7plXEO7kur7yzUNjcPGalwUiN6McmjG3//jW8Y3oBdy/kfc="
        on:
          tags: true
    - stage: Create GitHub release
      env: TOXENV=build
      before_deploy:
        - export AUTHOR_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty="%cE")"
        - export AUTHOR_NAME="$(git log -1 $TRAVIS_COMMIT --pretty="%aN")"
        - export GIT_TAG="$(cat version.txt | tr -d ' \t\n\r')"
        - git config --local user.name $AUTHOR_NAME
        - git config --local user.email $AUTHOR_EMAIL
        - git tag $GIT_TAG
      deploy:
        provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: "VqLRk9Z2GCBEUVrSIKHoOg/8+nyhMaO+JfMs2neiRfwVo0b5gKi33YndFVGIkDtKA1Fk5mTx5inMr4RFj8Ku6mi8QS8ogNy2mvq3dtPWCK+/CEP7ephwCnrWNnc34UiDrXTEvKzb4A2IfsWOXR7Pj1JLx+Yj7QvUcJM2zdgteONIVBkPkaLY8LBAgu7zRnM+L2uLUaU1J76iOW31ZAoWcUEQDKj2ZPo8v1OxEJwNqI4jjF5zb4fOVx+oT6XOorlklzcqGgiRCVbMGPxus4Q/+TEl1fP+uanu15mErjUxzwZISnmG6B/BkSbXOX6RppVF1LjkDWGqRfUw8CbFxJG3D2Ipzz5PAla5o2K2wqEQoJ2MldlfpBmRxMyVvTZl89hEaEX+SHGwCDl7hqAxXZsIDMfAUdcOulhibQvDUFyaUvC998Dm85v8ZPG+LZmEhqmrLcKpGWTH6wXNIoQHjAPba1vp6iQq8ctlFzpv43nbBGVsY/UhfERKq46Dx6ImORY/Idl1KDyxHUP958GhtdA5h/sSfM3rPoHsgKLjgNgE0wp/5dOFVCxZVBv48pqB7rueL/ivCy0XYHIlcyExjuwvCw2BjeNyXlDE39eC0smk5o8cZjS8Gn7Qpi9oNn7VVi6qyJuYIKfjy34qc0RAdOWG8cBoNcdnOa6RBGbbY+r79bE="
        file_glob: true
        file: dist/*
        name: cloudshell-shell-core $GIT_TAG
        target_commitish: master
        on:
          branch: master
    - stage: Check version
      language: bash
      install:
        - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
        - cd $TRAVIS_REPO_SLUG
        - git checkout -qf $TRAVIS_PULL_REQUEST_BRANCH
      script: "! git diff --exit-code --quiet origin/master version.txt"

install:
  - pip install tox
  - pip install codecov

script: tox

stages:
  - name: Check version
    if: branch = master AND type = pull_request
  - name: Test
  - name: Deploy to Test PyPI release
    if: branch = dev AND type != pull_request
  - name: Create GitHub release
    if: branch = master AND type != pull_request
  - name: Deploy to PyPI release
    if: tag IS present
